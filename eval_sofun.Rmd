---
title: "eval_sofun"
author: "Beni Stocker"
date: "`r Sys.Date()`"
# output:
#   html_document:
#     toc: true
#     toc_float: true
#     toc_depth: 4
#     number_sections: true
output:
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
header-includes:
   - \usepackage{amsmath}
bibliography: bibliography.bib
---

```{r "knitr config", cache = FALSE, include=FALSE}
require(knitr)
library(captioner)
library(rsofun)
load_dependencies_rsofun()
tab_nums <- captioner( prefix = "Table S", auto_space=FALSE, style = "i" )
fig_nums <- captioner( prefix = "Figure S", auto_space=FALSE, style = "i" )
systr <- "''"    # for Mac
```

# Evaluation of GPP against FLUXNET data

## Evaluation settings

For site-scale simulations the `rsofun` package requires a meta information file. Create this here for FLUXNET 2015 Tier 1 sites (their meta info is provided as a public variable by the package).
```{r}
write_csv( metainfo_Tier1_sites_kgclimate_fluxnet2015, path = "./ext/siteinfo_fluxnet2015.csv" )
```

Define settings.
```{r message=FALSE}
# load( "data/settings_sims_sitescale.Rdata" )
# load( "data/settings_input_sitescale.Rdata" )
# load( "data/setup_sofun_sitescale.Rdata" )

settings_sims_sitescale <- list(
  path_siteinfo   = "./ext/siteinfo_fluxnet2015.csv",
  ensemble        = TRUE,
  setup           = "site",
  name            = "fluxnet2015",
  dir_sofun       = "~/sofun/trunk/",
  path_output     = "~/sofun/output_fluxnet2015_sofun/s24/",
  path_output_nc  = "~/sofun/output_nc_fluxnet2015_sofun/s24/",
  path_input      = "~/sofun/input_fluxnet2015_sofun_TEST/",
  grid            = NA,
  implementation  = "fortran",
  in_ppfd         = TRUE,
  in_netrad       = FALSE,
  recycle         = 1,
  spinupyears     = 10,
  calibvars       = c("gpp"),
  soilmstress     = TRUE,
  tempstress      = TRUE,
  loutdgpp        = TRUE,
  loutdwcont      = TRUE,
  loutdaet        = TRUE,
  loutdpet        = TRUE,
  loutdalpha      = TRUE
  )

settings_input_sitescale <-  list(
  data                     = NA,
  temperature              = "fluxnet2015",
  precipitation            = "fluxnet2015",
  vpd                      = "fluxnet2015",
  ppfd                     = "fluxnet2015",
  netrad                   = NA,
  cloudcover               = "cru",
  path_watch_wfdei         = "~/data/watch_wfdei/",
  path_cru                 = "~/data/cru/ts_4.01/",
  path_MODIS_EVI_MOD13Q1   = "~/data/fapar_MODIS_EVI_MOD13Q1_gee_MOD13Q1_fluxnet2015_gee_subset/",
  path_MODIS_FPAR_MCD15A3H = "~/data/fapar_MODIS_FPAR_MCD15A3H_gee_MCD15A3H_fluxnet2015_gee_subset/",
  path_co2                 = "~/data/co2/cCO2_rcp85_const850-1765.dat",
  path_fluxnet2015         = "~/data/FLUXNET-2015_Tier1/20160128/point-scale_none_1d/original/unpacked/",
  get_from_remote          = FALSE
  )

setup_sofun_sitescale <- list(
  model      = "pmodel",
  dir        = "~/sofun/trunk",
  do_compile = FALSE,
  simsuite   = FALSE
  )
```

Define common model evaluation settings as a list.
```{r, message=FALSE}
mylist <- readr::read_csv("ext/myselect_fluxnet2015.csv") %>% dplyr::filter( use==1 ) %>% dplyr::select( -use ) %>% unlist()
settings_eval <- list(
  sitenames = dplyr::filter( metainfo_Tier1_sites_kgclimate_fluxnet2015, c4 %in% c(FALSE, NA) )$sitename,
  sitenames_siteplots = mylist,
  agg = 5,
  path_fluxnet2015_d = "~/data/FLUXNET-2015_Tier1/20160128/point-scale_none_1d/original/unpacked/",
  path_fluxnet2015_w = "~/data/FLUXNET-2015_Tier1/20160128/point-scale_none_7d/original/unpacked/",
  path_fluxnet2015_m = "~/data/FLUXNET-2015_Tier1/20160128/point-scale_none_1m/original/unpacked/",
  path_fluxnet2015_y = "~/data/FLUXNET-2015_Tier1/20160128/point-scale_none_1y/original/unpacked/",
  path_gepisat_d     = "~/data/gepisat/v3_fluxnet2015/daily_gpp/"
  )

# ## XXX TEST: Calibration sites for TerraP, excluding CA-Obs
# settings_eval$sitenames <- c("AU-Tum", "CA-NS3", "CA-NS6", "DE-Geb", "DE-Hai", "DE-Kli", "FI-Hyy", "FR-Fon", "FR-LBr", "FR-Pue", "IT-Cpz", "NL-Loo", "US-Ha1", "US-MMS", "US-UMB", "US-WCr")
# settings_eval$sitenames_siteplots <- mylist[ mylist %in% settings_eval$sitenames ]

```

- `benchmark`: Named list of character strings with data source identifiers for each calibration target variable. The list is named corresponding to variable names defined by 'targetvars'. The identifier triggers certain functions to be used for reading and processing observational data. Use, e.g., `datasource = list( gpp = "fluxnet2015_NT" )` to specify that observational data for the target variable `"gpp"` comes from FLUXNET 2015 dataset with GPP data based on the night-time flux decomposition method (`"NT"`). Alternatively, use GPP data based on the daytime method (`"fluxnet2015_NT"`) or Tyler Davis' new method (unpublished) (`"fluxnet2015_Ty"`). If multiple data sources are selected (e.g., `datasource = list( gpp = c("fluxnet2015_NT", "fluxnet2015_DT") )`), their mean is used for calibration.

<!-- ## Get additional site meta information

Get additional site meta information (Koeppen-Geiger climate) first from FLUXNET 2015 meta info file (`fluxnet_site_info_mysub.csv`), then, fill missing using info extracted from a global map (`koeppen-geiger.tif`). The Koeppen-Geiger climate class info is used to aggregate mean seasonal cycles of multiple sites falling within one climate class. 
```{r}
siteinfo_eval <- metainfo_Tier1_sites_kgclimate_fluxnet2015
``` 
 -->
## Evaluation of different simulation suites

Parameters are calibrated for six different simulation suites and parameter values saved in CSV files. The simulation suites are FLUXNET site-scale simulations with different fAPAR input data, differrent GPP calibration target data, and different model setups. 

### Excluding dry and cold days (`RED`)

Run SOFUN with calibrated parameters for the simulation suite based on splined MODIS FPAR MCD15A3H fAPAR data and excluding cold (<10$^{\circ}$) and dry (relative soil moisture below XXX) days. and  `r `
```{r, eval=TRUE, message=FALSE, warning=FALSE}
## Define new output directory and specific simulation parameters and re-run the setup step
settings_sims_sitescale$path_output_nc  = "~/sofun/output_nc_fluxnet2015_sofun/s24/"
settings_sims_sitescale$soilmstress = FALSE
settings_sims_sitescale$tempstress  = FALSE
settings_sims_sitescale$loutdgpp    = TRUE
settings_sims_sitescale$loutdrd     = FALSE
settings_sims_sitescale$loutdtransp = FALSE
settings_sims_sitescale$loutdwcont  = TRUE
settings_sims_sitescale$loutdaet    = TRUE
settings_sims_sitescale$loutdpet    = TRUE
settings_sims_sitescale$loutdalpha  = TRUE


## Define fAPAR input data and re-write input files for SOFUN
settings_input_sitescale$fapar = "MODIS_FPAR_MCD15A3H"
settings_input_sitescale$splined_fapar = TRUE

## run the model with these parameters and read output into mod_RED
if (!file.exists("data/mod_RED.Rdata")){

  settings_sims_sitescale <- prepare_setup_sofun( 
    settings = settings_sims_sitescale, 
    write_paramfils = TRUE 
    )

  ## Prepare and save input data for later use
  inputdata_FPARspl <- prepare_input_sofun( 
    settings_input = settings_input_sitescale, 
    settings_sims = settings_sims_sitescale, 
    return_data = FALSE, 
    overwrite_csv_fapar = TRUE, 
    verbose = TRUE
    )

  ## update files containing parameter values read by model
  params_opt <- readr::read_csv( "results_calib/params_opt_RED.csv" )
  nothing <- update_params( params_opt, settings_sims_sitescale$dir_sofun )

  mod_RED <- runread_sofun( 
    settings = settings_sims_sitescale, 
    setup = setup_sofun_sitescale 
    )
  save( mod_RED, file = "data/mod_RED.Rdata" )
} else {
  load("data/mod_RED.Rdata")
}

## get sites for which no model output is available and overwrite settings_eval$sitenames
missing_mod <- purrr::map_lgl( mod_RED$daily, ~identical(., NA ) ) %>% which() %>% names()
settings_eval$sitenames <- settings_eval$sitenames[which(!(settings_eval$sitenames %in% missing_mod))]

## Define other setup-specific evaluation settings
settings_eval$benchmark <- list( gpp = c("fluxnet2015_NT") )

## get observational data separately and save since it's the same for multiple evaluations
if (!file.exists("data/obs_eval_NT.Rdata")){
  obs_eval_NT <- get_obs_eval( settings_eval = settings_eval, settings_sims = settings_sims_sitescale, overwrite = TRUE )
  save( obs_eval_NT, file = "data/obs_eval_NT.Rdata")
} else {
  load("data/obs_eval_NT.Rdata")
}

## evaluate RED simulations
if (!file.exists("data/out_eval_RED.Rdata")){
  out_eval_RED <- eval_sofun( mod_RED, settings_eval, settings_sims_sitescale, obs_eval = obs_eval_NT, overwrite = TRUE )
  save( out_eval_RED, file = "data/out_eval_RED.Rdata" )
} else {
  load("data/out_eval_RED.Rdata")
}

row_rsqtable_RED <- bind_cols( Setup = "RED", getrow_statstable( out_eval_RED, stat = "rsq" ) )

## Plot mod-vs-obs for daily values
# if (!exists("out_eval_RED")) load("data/out_eval_RED.Rdata")
# modobs_ddf_RED <- plot_modobs_daily( out_eval_RED$data$ddf, subtitle = "RED, FPARspl, NT", dir = "./fig", makepdf = TRUE )
```



### Including empirical soil moisture and temperature stress functions (`FULL`)

Run SOFUN with calibrated parameters for the simulation suite based on splined MODIS FPAR MCD15A3H fAPAR data and excluding cold (<10$^{\circ}$) and dry (relative soil moisture below XXX) days. and  `r `
```{r, eval=TRUE, message=FALSE, warning=FALSE}
## Define new output directory and specific simulation parameters and re-run the setup step
settings_sims_sitescale$path_output_nc  = "~/sofun/output_nc_fluxnet2015_sofun/s25/"
settings_sims_sitescale$soilmstress = TRUE
settings_sims_sitescale$tempstress  = TRUE

## Define fAPAR input data and re-write input files for SOFUN - THE SAME AS ABOVE
settings_input_sitescale$fapar = "MODIS_FPAR_MCD15A3H"
settings_input_sitescale$splined_fapar = TRUE

## run the model with these parameters and read output into mod_FULL
if (!file.exists("data/mod_FULL.Rdata")){

  settings_sims_sitescale <- prepare_setup_sofun(
    settings = settings_sims_sitescale, 
    write_paramfils = TRUE 
    )

  # Prepare and save input data for later use - THE SAME AS ABOVE
  inputdata_FPARspl <- prepare_input_sofun( 
    settings_input = settings_input_sitescale, 
    settings_sims = settings_sims_sitescale, 
    return_data = FALSE, 
    overwrite_csv_fapar = TRUE, 
    verbose = TRUE
    )

  ## update files containing parameter values read by model
  params_opt <- readr::read_csv( "results_calib/params_opt_FULL.csv" )
  nothing <- update_params( params_opt, settings_sims_sitescale$dir_sofun )

  mod_FULL <- runread_sofun( 
    settings = settings_sims_sitescale, 
    setup = setup_sofun_sitescale 
    )
  save( mod_FULL, file = "data/mod_FULL.Rdata" )
} else {
  load("data/mod_FULL.Rdata")
}

## get sites for which no model output is available and overwrite settings_eval$sitenames
missing_mod <- purrr::map_lgl( mod_FULL$daily, ~identical(., NA ) ) %>% which() %>% names()
settings_eval$sitenames <- settings_eval$sitenames[which(!(settings_eval$sitenames %in% missing_mod))]

## Define other setup-specific evaluation settings - THE SAME AS ABOVE
settings_eval$benchmark <- list( gpp = c("fluxnet2015_NT") )

# get observational data separately and save since it's the same for multiple evaluations - THE SAME AS ABOVE
if (!file.exists("data/obs_eval_NT.Rdata")){
  obs_eval_NT <- get_obs_eval( settings_eval = settings_eval, settings_sims = settings_sims_sitescale, overwrite = TRUE )
  save( obs_eval_NT, file = "data/obs_eval_NT.Rdata")
} else {
  load("data/obs_eval_NT.Rdata")
}

## evaluate FULL simulations
if (!file.exists("data/out_eval_FULL.Rdata")){
  out_eval_FULL <- eval_sofun( mod_FULL, settings_eval, settings_sims_sitescale, obs_eval = obs_eval_NT, overwrite = TRUE )
  save( out_eval_FULL, file = "data/out_eval_FULL.Rdata" )
} else {
  load("data/out_eval_FULL.Rdata")
}

row_rsqtable_FULL <- bind_cols( Setup = "FULL", getrow_statstable( out_eval_FULL, stat = "rsq" ) )
```


### Null model of constant LUE (`NULL`)

Assume that light use efficiency (LUE) is constant and GPP is calculated as:
$$
\text{GPP} = \text{fAPAR} \times \text{PAR} \times \text{LUE}  
$$
LUE is a constant and is calibrated, given GPP data (here based on the nighttime decomposition method). fAPAR is splined MODIS FPAR MCD15A3H.

```{r, eval=TRUE, message=FALSE, warning=FALSE}
if (!file.exists("data/obs_eval_NT.Rdata")){
  obs_eval_NT <- get_obs_eval( settings_eval = settings_eval, settings_sims = settings_sims_sitescale, overwrite = TRUE )
  save( obs_eval_NT, file = "data/obs_eval_NT.Rdata")
} else {
  load("data/obs_eval_NT.Rdata")
}
mod_NULL <- obs_eval_NT$ddf %>% 
            dplyr::select( sitename, date, gpp_obs, ppfd_fluxnet2015, fapar ) %>% 
            mutate( apar = ppfd_fluxnet2015 * fapar ) %>% 
            mutate( gpp_obs = ifelse( date < "2000-02-18", NA, gpp_obs ) )

## to fit constant LUE, fit linear model with zero intercept and just use its coefficient (slope)
linmod <- lm( gpp_obs ~ 0 + apar, data = mod_NULL )

mod_NULL <- mod_NULL %>% 
  dplyr::select( sitename, date, apar ) %>%
  mutate( gpp = coef(linmod) * apar ) %>%
  dplyr::select( -apar )

## change the structure to something like the one of mod_FULL and mod_RED
tmp <- purrr::map( as.list( unique(mod_NULL$sitename)), ~filter( mod_NULL, sitename==. ) %>% dplyr::select(-sitename) )
names(tmp) <- unique(mod_NULL$sitename)
mod_NULL <- list()
mod_NULL$daily <- tmp
rm("tmp")

## evaluate NULL simulations
if (!file.exists("data/out_eval_NULL.Rdata")){
  out_eval_NULL <- eval_sofun( mod_NULL, settings_eval, settings_sims_sitescale, obs_eval = obs_eval_NT, overwrite = TRUE )
  save( out_eval_NULL, file = "data/out_eval_NULL.Rdata" )
} else {
  load("data/out_eval_NULL.Rdata")
}

row_rsqtable_NULL <- bind_cols( Setup = "NULL", getrow_statstable( out_eval_NULL, stat = "rsq" ) )
```


### Null model of constant LUE by PFT (`NULLpft`)

Here, assume a different constant LUE for each PFT, or vegetation type.
LUE is a constant and is calibrated, given GPP data (here based on the nighttime decomposition method). fAPAR is splined MODIS FPAR MCD15A3H.

```{r, eval=TRUE, message=FALSE, warning=FALSE}
add_gpp_mod <- function( data ){
  linmod <- lm( gpp_obs ~ 0 + apar, data = data, na.action = "na.exclude" )
  data$gpp_mod <- coef(linmod)[["apar"]] * data$apar # fitted( linmod )
  return(data)  
}

## Get coefficient (constant LUE) for each PFT ('classid') and use this to estimate 'gpp_mod' 
sum_NULLpft <-  obs_eval_NT$ddf %>% 
                dplyr::select( sitename, date, gpp_obs, ppfd_fluxnet2015, fapar ) %>% 
                mutate( apar = ppfd_fluxnet2015 * fapar, gpp_obs = ifelse( date < "2000-02-18", NA, gpp_obs ) ) %>%
                left_join( dplyr::rename( dplyr::select( metainfo_Tier1_sites_kgclimate_fluxnet2015, sitename, classid )), by = "sitename" ) %>%
                group_by( classid ) %>%
                nest() %>%
                mutate( nobs = purrr::map( data, ~sum(!is.na( .$gpp_obs )  ) ) ) %>%
                unnest( nobs ) %>%
                filter( nobs > 2 ) %>%
                mutate( linmod = purrr::map( data, ~lm( gpp_obs ~ 0 + apar, data = . ) ) ) %>%
                mutate( coef   = purrr::map( linmod, ~coef(.) ) ) %>%
                unnest( coef ) %>%
                mutate( data   = purrr::map( data, ~add_gpp_mod(.) ) ) %>%
                mutate( stats  = purrr::map( data, ~get_stats( .$gpp_mod, .$gpp_obs ) ) ) %>%
                unnest( stats )
    		                 
## Unnest the data again to get a long data frame                         
mod_NULLpft <- sum_NULLpft %>% 
                dplyr::select( data ) %>%
                unnest( data ) %>%
                dplyr::select( sitename, date, gpp = gpp_mod )

## change the structure to something like the one of mod_FULL and mod_RED
tmp <- purrr::map( as.list( unique(mod_NULLpft$sitename)), ~filter( mod_NULLpft, sitename==. ) %>% dplyr::select(-sitename) )
names(tmp) <- unique(mod_NULLpft$sitename)
mod_NULLpft <- list()
mod_NULLpft$daily <- tmp
rm("tmp")

## evaluate NULL simulations
if (!file.exists("data/out_eval_NULLpft.Rdata")){
  out_eval_NULLpft <- eval_sofun( mod_NULLpft, settings_eval, settings_sims_sitescale, obs_eval = obs_eval_NT, overwrite = TRUE )
  save( out_eval_NULLpft, file = "data/out_eval_NULLpft.Rdata" )
} else {
  load("data/out_eval_NULLpft.Rdata")
}

row_rsqtable_NULLpft <- bind_cols( Setup = "NULLpft", getrow_statstable( out_eval_NULLpft, stat = "rsq" ) )
```


### Sensitivity to greenness data with interpolated FPAR data (`RED_FPARitp`)

Run SOFUN with calibrated parameters for the simulation suite based on splined MODIS FPAR MCD15A3H fAPAR data and excluding cold (<10$^{\circ}$) and dry (relative soil moisture below XXX) days. and  `r `
```{r, eval=TRUE, message=FALSE, warning=FALSE}
## Define new output directory and specific simulation parameters and re-run the setup step
settings_sims_sitescale$path_output_nc  = "~/sofun/output_nc_fluxnet2015_sofun/s26/"
settings_sims_sitescale$soilmstress = FALSE
settings_sims_sitescale$tempstress  = FALSE

## Define fAPAR input data and re-write input files for SOFUN
settings_input_sitescale$fapar = "MODIS_FPAR_MCD15A3H"
settings_input_sitescale$splined_fapar = FALSE

## run the model with these parameters and read output into mod_RED_FPARitp
if (!file.exists("data/mod_RED_FPARitp.Rdata")){

  settings_sims_sitescale <- prepare_setup_sofun( 
    settings = settings_sims_sitescale, 
    write_paramfils = TRUE 
    )

  ## Prepare and save input data for later use
  inputdata_FPATitpl <- prepare_input_sofun( 
    settings_input = settings_input_sitescale, 
    settings_sims = settings_sims_sitescale, 
    return_data = FALSE, 
    overwrite_csv_fapar = TRUE, 
    verbose = TRUE
    )

  ## update files containing parameter values read by model
  params_opt <- readr::read_csv( "results_calib/params_opt_RED_FPARitp.csv" )
  nothing <- update_params( params_opt, settings_sims_sitescale$dir_sofun )

  mod_RED_FPARitp <- runread_sofun( 
    settings = settings_sims_sitescale, 
    setup = setup_sofun_sitescale 
    )
  save( mod_RED_FPARitp, file = "data/mod_RED_FPARitp.Rdata" )
} else {
  load("data/mod_RED_FPARitp.Rdata")
}

## get sites for which no model output is available and overwrite settings_eval$sitenames
missing_mod <- purrr::map_lgl( mod_RED_FPARitp$daily, ~identical(., NA ) ) %>% which() %>% names()
settings_eval$sitenames <- settings_eval$sitenames[which(!(settings_eval$sitenames %in% missing_mod))]

## Define other setup-specific evaluation settings
settings_eval$benchmark <- list( gpp = c("fluxnet2015_NT") )

## get observational data separately and save since it's the same for multiple evaluations
if (!file.exists("data/obs_eval_NT.Rdata")){
  obs_eval_NT <- get_obs_eval( settings_eval = settings_eval, settings_sims = settings_sims_sitescale, overwrite = TRUE )
  save( obs_eval_NT, file = "data/obs_eval_NT.Rdata")
} else {
  load("data/obs_eval_NT.Rdata")
}

## evaluate RED_FPARitp simulations
if (!file.exists("data/out_eval_RED_FPARitp.Rdata")){
  out_eval_RED_FPARitp <- eval_sofun( mod_RED_FPARitp, settings_eval, settings_sims_sitescale, obs_eval = obs_eval_NT, overwrite = TRUE )
  save( out_eval_RED_FPARitp, file = "data/out_eval_RED_FPARitp.Rdata" )
} else {
  load("data/out_eval_RED_FPARitp.Rdata")
}

row_rsqtable_RED_FPARitp <- bind_cols( Setup = "RED_FPARitp", getrow_statstable( out_eval_RED_FPARitp, stat = "rsq" ) )
```


### Sensitivity to greenness data with interpolated EVI data (`RED_EVI`)

Run SOFUN with calibrated parameters for the simulation suite based on splined MODIS FPAR MCD15A3H fAPAR data and excluding cold (<10$^{\circ}$) and dry (relative soil moisture below XXX) days. and  `r `
```{r, eval=TRUE, message=FALSE, warning=FALSE}
## Define new output directory and specific simulation parameters and re-run the setup step
settings_sims_sitescale$path_output_nc  = "~/sofun/output_nc_fluxnet2015_sofun/s27/"
settings_sims_sitescale$soilmstress = FALSE
settings_sims_sitescale$tempstress  = FALSE

## Define fAPAR input data and re-write input files for SOFUN
settings_input_sitescale$fapar = "MODIS_EVI_MOD13Q1"
settings_input_sitescale$splined_fapar = FALSE

## run the model with these parameters and read output into mod_RED_EVI
if (!file.exists("data/mod_RED_EVI.Rdata")){

  settings_sims_sitescale <- prepare_setup_sofun( 
    settings = settings_sims_sitescale, 
    write_paramfils = TRUE 
    )

  ## Prepare and save input data for later use
  inputdata_EVI <- prepare_input_sofun( 
    settings_input = settings_input_sitescale, 
    settings_sims = settings_sims_sitescale, 
    return_data = FALSE, 
    overwrite_csv_fapar = TRUE, 
    verbose = FALSE
    )

  ## update files containing parameter values read by model
  params_opt <- readr::read_csv( "results_calib/params_opt_RED_EVI.csv" )
  nothing <- update_params( params_opt, settings_sims_sitescale$dir_sofun )

  settings_sims_sitescale$loutdrd     = FALSE
  settings_sims_sitescale$loutdtransp = FALSE
  mod_RED_EVI <- runread_sofun( 
    settings = settings_sims_sitescale, 
    setup = setup_sofun_sitescale 
    )
  save( mod_RED_EVI, file = "data/mod_RED_EVI.Rdata" )
} else {
  load("data/mod_RED_EVI.Rdata")
}

## get sites for which no model output is available and overwrite settings_eval$sitenames
missing_mod <- purrr::map_lgl( mod_RED_EVI$daily, ~identical(., NA ) ) %>% which() %>% names()
settings_eval$sitenames <- settings_eval$sitenames[which(!(settings_eval$sitenames %in% missing_mod))]

## Define other setup-specific evaluation settings
settings_eval$benchmark <- list( gpp = c("fluxnet2015_NT") )

## get observational data separately and save since it's the same for multiple evaluations
if (!file.exists("data/obs_eval_NT.Rdata")){
  obs_eval_NT <- get_obs_eval( settings_eval = settings_eval, settings_sims = settings_sims_sitescale, overwrite = TRUE )
  save( obs_eval_NT, file = "data/obs_eval_NT.Rdata")
} else {
  load("data/obs_eval_NT.Rdata")
}

## evaluate RED_EVI simulations
if (!file.exists("data/out_eval_RED_EVI.Rdata")){
  out_eval_RED_EVI <- eval_sofun( mod_RED_EVI, settings_eval, settings_sims_sitescale, obs_eval = obs_eval_NT, overwrite = TRUE )
  save( out_eval_RED_EVI, file = "data/out_eval_RED_EVI.Rdata" )
} else {
  load("data/out_eval_RED_EVI.Rdata")
}

row_rsqtable_RED_EVI <- bind_cols( Setup = "RED_EVI", getrow_statstable( out_eval_RED_EVI, stat = "rsq" ) )
```


### Sensitivity to GPP data with DT (`RED_DT`)

Calibrating and evaluating SOFUN against GPP data based on the daytime decomposition method.
```{r, eval=TRUE, message=FALSE, warning=FALSE}
## Define new output directory and specific simulation parameters and re-run the setup step
settings_sims_sitescale$path_output_nc  = "~/sofun/output_nc_fluxnet2015_sofun/s28/"
settings_sims_sitescale$soilmstress = FALSE
settings_sims_sitescale$tempstress  = FALSE

## Define fAPAR input data and re-write input files for SOFUN
settings_input_sitescale$fapar = "MODIS_FPAR_MCD15A3H"
settings_input_sitescale$splined_fapar = TRUE

## run the model with these parameters and read output into mod_RED_EVI
if (!file.exists("data/mod_RED_DT.Rdata")){

  settings_sims_sitescale <- prepare_setup_sofun( 
    settings = settings_sims_sitescale, 
    write_paramfils = FALSE
    )

  ## Prepare and save input data for later use
  inputdata_FPARspl <- prepare_input_sofun( 
    settings_input = settings_input_sitescale, 
    settings_sims = settings_sims_sitescale, 
    return_data = FALSE, 
    overwrite_csv_fapar = TRUE, 
    verbose = TRUE
    )

  ## update files containing parameter values read by model
  params_opt <- readr::read_csv( "results_calib/params_opt_RED_DT.csv" )
  nothing <- update_params( params_opt, settings_sims_sitescale$dir_sofun )

  settings_sims_sitescale$loutdrd     = FALSE
  settings_sims_sitescale$loutdtransp = FALSE
  mod_RED_DT <- runread_sofun( 
    settings = settings_sims_sitescale, 
    setup = setup_sofun_sitescale 
    )
  save( mod_RED_DT, file = "data/mod_RED_DT.Rdata" )
} else {
  load("data/mod_RED_DT.Rdata")
}

## get sites for which no model output is available and overwrite settings_eval$sitenames
missing_mod <- purrr::map_lgl( mod_RED_DT$daily, ~identical(., NA ) ) %>% which() %>% names()
settings_eval$sitenames <- settings_eval$sitenames[which(!(settings_eval$sitenames %in% missing_mod))]

## Define other setup-specific evaluation settings
settings_eval$benchmark <- list( gpp = c("fluxnet2015_DT") )

## get observational data separately and save since it's the same for multiple evaluations
if (!file.exists("data/obs_eval_DT.Rdata")){
  obs_eval_DT <- get_obs_eval( settings_eval = settings_eval, settings_sims = settings_sims_sitescale, overwrite = TRUE )
  save( obs_eval_DT, file = "data/obs_eval_DT.Rdata")
} else {
  load("data/obs_eval_DT.Rdata")
}

## evaluate RED_DT simulations
if (!file.exists("data/out_eval_RED_DT.Rdata")){
  out_eval_RED_DT <- eval_sofun( mod_RED_DT, settings_eval, settings_sims_sitescale, obs_eval = obs_eval_DT, overwrite = TRUE )
  save( out_eval_RED_DT, file = "data/out_eval_RED_DT.Rdata" )
} else {
  load("data/out_eval_RED_DT.Rdata")
}

row_rsqtable_RED_DT <- bind_cols( Setup = "RED_DT", getrow_statstable( out_eval_RED_DT, stat = "rsq" ) )
```


### Sensitivity to GPP data with Ty (`RED_Ty`)

Calibrating and evaluating SOFUN against GPP data based on the alternative flux decomposition method by Tyler's method (GePiSaT data).
```{r, eval=TRUE, message=FALSE, warning=FALSE}
## Define new output directory and specific simulation parameters and re-run the setup step
settings_sims_sitescale$path_output_nc  = "~/sofun/output_nc_fluxnet2015_sofun/s29/"
settings_sims_sitescale$soilmstress = FALSE
settings_sims_sitescale$tempstress  = FALSE

## Define fAPAR input data and re-write input files for SOFUN
settings_input_sitescale$fapar = "MODIS_FPAR_MCD15A3H"
settings_input_sitescale$splined_fapar = TRUE

## run the model with these parameters and read output into mod_RED_EVI
if (!file.exists("data/mod_RED_Ty.Rdata")){

  settings_sims_sitescale <- prepare_setup_sofun( 
    settings = settings_sims_sitescale, 
    write_paramfils = FALSE
    )

  ## Prepare and save input data for later use
  inputdata_FPARspl <- prepare_input_sofun( 
    settings_input = settings_input_sitescale, 
    settings_sims = settings_sims_sitescale, 
    return_data = FALSE, 
    overwrite_csv_fapar = TRUE, 
    verbose = TRUE
    )

  ## update files containing parameter values read by model
  params_opt <- readr::read_csv( "results_calib/params_opt_RED_Ty.csv" )
  nothing <- update_params( params_opt, settings_sims_sitescale$dir_sofun )

  settings_sims_sitescale$loutdrd     = FALSE
  settings_sims_sitescale$loutdtransp = FALSE
  mod_RED_Ty <- runread_sofun( 
    settings = settings_sims_sitescale, 
    setup = setup_sofun_sitescale 
    )
  save( mod_RED_Ty, file = "data/mod_RED_Ty.Rdata" )
} else {
  load("data/mod_RED_Ty.Rdata")
}

## get sites for which no model output is available and overwrite settings_eval$sitenames
missing_mod <- purrr::map_lgl( mod_RED_Ty$daily, ~identical(., NA ) ) %>% which() %>% names()
settings_eval$sitenames <- settings_eval$sitenames[which(!(settings_eval$sitenames %in% missing_mod))]

## Define other setup-specific evaluation settings
settings_eval$benchmark <- list( gpp = c("fluxnet2015_Ty") )

## get observational data separately and save since it's the same for multiple evaluations
if (!file.exists("data/obs_eval_Ty.Rdata")){
  obs_eval_Ty <- get_obs_eval( settings_eval = settings_eval, settings_sims = settings_sims_sitescale, overwrite = TRUE )
  save( obs_eval_Ty, file = "data/obs_eval_Ty.Rdata")
} else {
  load("data/obs_eval_Ty.Rdata")
}

## evaluate RED_Ty simulations
if (!file.exists("data/out_eval_RED_Ty.Rdata")){
  out_eval_RED_Ty <- eval_sofun( mod_RED_Ty, settings_eval, settings_sims_sitescale, obs_eval = obs_eval_Ty, overwrite = TRUE )
  save( out_eval_RED_Ty, file = "data/out_eval_RED_Ty.Rdata" )
} else {
  load("data/out_eval_RED_Ty.Rdata")
}

row_rsqtable_RED_Ty <- bind_cols( Setup = "RED_Ty", getrow_statstable( out_eval_RED_Ty, stat = "rsq" ) )
```

## Sites selection

Sites used for the model evaluation are shown on the map below. An overview table is in the Appendix (last section of this document).

```{r siteoverview_fig, echo=FALSE, warning=FALSE, message=FALSE}
require(ncdf4, quietly = TRUE)
ncfiln <- "../data/greve/ep_over_p_cru_ncep.nc"
if (!file.exists(ncfiln)) {
  epop <- array( 1, dim=c(720,360) )
} else {
  nc <- nc_open( ncfiln )
  epop <- ncvar_get( nc, varid="EP_OVER_P_CRU_NCEP" )
}
source("plot_map_siteoverview.R")
plot_map_siteoverview( dplyr::filter( metainfo_Tier1_sites_kgclimate_fluxnet2015, mysitename %in% settings_eval$sitenames ), 1/epop ) # , plotfiln="fig/map_sites.pdf"
cap_siteoverview_fig <- fig_nums( "siteoverview_fig", caption=" Geographical distribution of sites selected for the bias evaluation. Sites listed in Table S1 as group 1 are in green, sites of group 2 are in black. The color of land area represents aridity, quantified as the ratio of potential evapotranspiration over precipitation from xxx" )
```

`r fig_nums("siteoverview_fig")`

## Data processing

Daily data are used from the FLUXNET 2015 Tier 1 dataset, downloaded on 13. November, 2016. We use GPP as the mean of values based on the Nighttime Partitioning and the Daytime Partitioning method, both based on the Variable U-Star Threshold method (variables in the FLUXNET 2015 dataset named `GPP_NT_VUT_REF` and `GPP_DT_VUT_REF`). In the FLUXNET 2015 dataset, daily values are sums over half-hourly data. We use only daily values where less than 50% of respective half-hourly data is gap-filled. We further removed data points where the daytime and nighttime methods (`GPP_DT_VUT_REF` and `GPP_NT_VUT_REF`, resp.) are inconsistent. I.e., the upper and lower 2.5% quantile of the difference between each method's GPP quantification. Finally, we removed all negative daily GPP values.

## P-model parameter calibration

The P-model relies on a minimum set of free parameters. Most parameters are given by known physical laws with accurately defined parameters (e.g., viscosity of water) or well-established physiological relationships with independently constrained parameters (e.g., enzyme kinetics of C3 photosynthesis). Two key free parameters are:

- the ratio of costs for maintaining transpiration versus carboxylation $\beta$.
- the quantum yield efficiency $\varphi_0$.

We applied a value of 146.0 for $\beta$ based on independent constraints from $\delta^{13}$C measurements on leaves (Prentice et al., 2014; Wang Han et al., 2017).

$\varphi_0$ determines the fraction of absorbed light that can be used by the photosynthetic aparatus for assimilating CO$_2$. Within the P-model, this parameter acts as a linear scalar between absorbed light and GPP and therefore implies a strong sensitivity of simulated GPP to its valule. Considerable uncertainty resides in the quantification of fAPAR and some inconsistency in terms of its definition. Hence, we consider $\varphi_0$ as a free parameter that we calibrate, given the fAPAR data product used. Here, we use the MODIS FPAR MCD15A3H data product at 1 km/8 day resolution and extract values for a single pixel surrounding the flux tower location. Calibration was done ...

**OPEN POINT:**
I did a such a calibration and got $\varphi_0 = 0.0579$, as described [here](http://rpubs.com/stineb/calib_pmodel). I filtered out data points taken at low temperatures ($<5^{\circ}C$) and at low soil moisture ($<0.4$ relative soil water content). The calibration target was `GPP_NT_VUT_REF`. Now, I've implemented a more flexible and capable calibration function for SOFUN, allowing for multiple parameters to be calibrated simultaneously and accounting for uncertainty in the data. This makes use of different parameter search algorithms implemented in R.

- How to use uncertainty data from FLUXNET 2015? Just use one the nighttime partitioning and use `GPP_NT_VUT_MEAN` and `GPP_NT_VUT_SE`? Or how to account for uncertainty related to the difference between the nighttime and daytime partitioning approach? Thus: how to additionally use `GPP_DT_VUT_MEAN` and `GPP_DT_VUT_SE`?

## Metrics

Several performance metrics are calculated for different features of GPP variability. The performance metrics are:

- R$^2$
- RMSE
- slope (of regression observed over modelled)
- bias

The features of variability in GPP, for which model-observation agreement is calculated, are:

- mean annual values (giving "spatial" correlation)
- annual anomalies from mean across years
- daily values, absolute
- mean across X-day periods, absolute
- mean seasonal cycle (mean by day of year)
- daily anomalies from mean seasonal cycle


## Results of evaluation

### Metrics table

```{r}
table_rsq <- rbind( row_rsqtable_NULL, row_rsqtable_NULLpft, row_rsqtable_RED, row_rsqtable_FULL, row_rsqtable_RED_FPARitp, row_rsqtable_RED_EVI, row_rsqtable_RED_DT, row_rsqtable_RED_Ty )
table_rsq_formatted <- table_rsq %>% mutate_at( vars(one_of("spatial", "annual", "monthly", "daily", "seasonal", "annual_var", "daily_var")), funs(format(., digits=3)))
latextable <- xtable::xtable( table_rsq_formatted, caption = "Caption text" )
print( latextable, hline.after=c(-1, 0), tabular.environment = "longtable", file = "table_rsq.tex" )

library(tidyr)
out_eval_RED$metrics$gpp$fluxnet2015 %>%
  bind_rows() %>%
  unnest() %>%
  mutate( level = (out_eval_RED$metrics$gpp$fluxnet2015 %>% names()) ) %>%
  mutate_at( vars(one_of("rsq", "rmse", "slope", "bias")), funs(format(., digits=3))) %>%
  dplyr::select( Level=level, N=nvals, R2=rsq, RMSE=rmse, Slope=slope, Bias=bias) %>%
  knitr::kable( caption="Performance metrics of correlations between modelled and observed values at different temporal aggregation levels, absolute values and anomalies.")
```

<!-- ### Annual values -->

<!-- Annual values in modelled and simulated GPP can be decomposed into the mean annual GPP per site $\overline{X}_i$ and its anomaly from the multi-annual mean $X'_{i,t}$: -->
<!-- $$ -->
<!-- X_{i,t} = \overline{X}_i + X'_{i,t} -->
<!-- $$ -->

### Combined spatial/annual

This shows the same as in the SI of our submitted manuscript: Figures S14 and S15 [here](http://rpubs.com/stineb/si_soilm_global).

```{r, echo=FALSE, fig.width=7.6, fig.height=7, echo=FALSE, message=FALSE, warning=FALSE}
## Use customized plotting
source("plot_modobs_spatial_annual.R")
plot_modobs_spatial_annual( out_eval_RED, xlim = c(0,4000), ylim = c(0,4000), makepdf = TRUE, pattern = "RED" )
plot_modobs_spatial_annual( out_eval_NULL, xlim = c(0,4000), ylim = c(0,4000), makepdf = TRUE, pattern = "NULL" )
```

#### Seasonal cycle by climate zones

More insights are provided by looking at the seasonal cycle explicitly. Plots for each site are given in the Appendix. Aggregating across multiple sites doesn't make much sense. However, I aggregated across climate zones and distinguishing between respective zones on the northern and southern hemisphere.

The classification of sites into Koeppen-Geiger climate zones is based on Falge et al. 2016. [ORNL DAAC](https://doi.org/10.3334/ORNLDAAC/1530), and complemented by extracting information from a global map. A table explaining the Koeppen-Geiger codes is given below.
```{r message=FALSE, warning=FALSE, echo=FALSE}
koeppen_legend %>% knitr::kable(caption = "Koeppen-Geiger climate zones.")
```

## Mean seasonality by climate zone

Plot only for climate zones where data from at least five different sites are available. 

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=7.6, fig.height=7, echo=FALSE, message=FALSE, warning=FALSE}
source("plot_by_doy_allzones.R")
plot_by_doy_allzones( out_eval_RED, makepdf=TRUE, pattern="RED" ) # out_eval_FULL, out_eval_RED_EVI, 
plot_by_doy_allzones( out_eval_RED, makepdf=TRUE, pattern="FULL" ) # out_eval_FULL, out_eval_RED_EVI, 
plot_by_doy_allzones( out_eval_NULL, makepdf=TRUE, pattern="NULL" )
plot_by_doy_allzones( out_eval_RED_EVI, makepdf=TRUE, pattern="RED_EVI" )

metainfo_Tier1_sites_kgclimate_fluxnet2015 %>% 
  mutate( hemisphere = ifelse( lat>0, "north", "south" ) ) %>% 
  group_by( koeppen_code, hemisphere ) %>% 
  summarise( nsites = n() ) %>% 
  left_join( dplyr::rename( koeppen_legend, koeppen_code = Code ), by = "koeppen_code" )%>% 
  arrange( -nsites )
```

Insights from seasonality analysis by climate zones (results see below, red is the model, black the observations, discussing only climate zones with data from more than three sites):

- Big problems simulating GPP in the Tropics (Am, Equatorial monsoon): substantial underestimation during most of the year except a short period (Is that the dry period?). Could be related to fAPAR data contaminated by clouds except during the dry period? Unfortunately, only two sites are available in this climate zone.
- Insufficient GPP decline during dry periods in tropical and hot climates (Aw: Equatorial savannah with dry winter, and BSh: Arid Steppe hot). This is not a surprise. The empirical soil moisture correction is **not** applied here.
- Overestimation of GPP in arid steppes (BSk: Arid Steppe cold). Quite robust, seen at 7 sites in total. Probably, model improved by soil moisture correction.
- In temperate and boreal regions, early-season GPP is consistently overestimated, and late-season in most cases (Cfa: Warm temperate fully humid with hot summer, Cfb: Warm temperate fully humid with warm summer, Dfb: Snow fully humid warm summer, Dfc: Snow fully humid cool summer). It looks like at cold air (or soil?) temperatures, GPP tends to be overestimated.
- There is a general overestimation of GPP at sites in Cwcb (Warm temperate with dry winter and warm summer).

In brief, there is room for improvement by reducing GPP at low temperatures (sort of found before, but we never dealt with a temperature ramp, and why should we?) and low soil moisture (of course). fAPAR data in the tropics needs to be examined, otherwise, it looks like we have a problem with the Aw sites.


### Monthly values

Ignoring that we don't expect a LUE-type linear relationship between absorbed light $I_{\text{abs}}$ and GPP, we can still evaluate the daily GPP estimated by the P-model:
$$
\text{GPP}(d) = \text{LUE}(m|d)\; \times \; I_{\text{abs}}(d)
$$
Here, $LUE(m|d)$ is the monthly varying light use efficiency simulated by the P-model using forcing data averaged to monthly means. $m|d$ refers to the month of a given day.

The correlation is still quite good...

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=7.6, fig.height=7, echo=FALSE, message=FALSE}
source("plot_modobs_daily.R")
# modobs_ddf <- plot_modobs_daily(   out_eval_RED, makepdf=TRUE, xlim=c(0,25), ylim=c(0,25) )
# modobs_xdf <- plot_modobs_xdaily(  out_eval_RED, makepdf=TRUE, xlim=c(0,25), ylim=c(0,25) )
modobs_mdf <- plot_modobs_monthly( out_eval_RED, makepdf=TRUE, xlim=c(0,20), ylim=c(0,20), pattern = "RED" )
modobs_mdf <- plot_modobs_monthly( out_eval_FULL, makepdf=TRUE, xlim=c(0,20), ylim=c(0,20), pattern = "FULL" )
modobs_mdf <- plot_modobs_monthly( out_eval_NULL, makepdf=TRUE, xlim=c(0,20), ylim=c(0,20), pattern = "NULL" )
```

### Daily anomalies

```{r}
source("plot_modobs_anomalies_daily.R")
modobs_anomalies_daily_RED  <- plot_modobs_anomalies_daily( out_eval_RED,  makepdf=TRUE, pattern = "RED" )
modobs_anomalies_daily_FULL <- plot_modobs_anomalies_daily( out_eval_FULL, makepdf=TRUE, pattern = "FULL" )
modobs_anomalies_daily_NULL <- plot_modobs_anomalies_daily( out_eval_NULL, makepdf=TRUE, pattern = "NULL" )
```


### Functional relationships

Functional relationships seen in the data can be extracted using Artificial Neural Networks (ANN). This is done here. First, a model is fitted to observed GPP with temperature, PPFD, VPD, fAPAR, and soil moisture as predictors. Then, functional relationships are evaluated by using the trained ANN to predict values for a synthetic datasets. The synthetic dataset is generated for each predictor value. E.g. for temperature, a sample of 50 data points is drawn from the empirical distribution of VPD, fAPAR, PPFD, and soil moisture, respectively, and 50 levels of temperature (evenly from 0-40 $^{\circ}$C) Then, the dataset is created by all combinations of these variables. Finally, functional relationship between temperature and GPP are assessed by taking the mean across all variable combination for each level of temperature separately. This approach implies that for the evaluation, correlations between predictor variables in the observational dataset are ignored.

In order to improve comparability, ANNs are trained at (P-) modelled and observed GPP, and functional relationships thus derived for observed and modelled. This improves comparability and is preferred here over evaluating the model directly. As always, observations are in black and modelled in red.

```{r neuralnet, echo=FALSE, message=FALSE, warning=FALSE, fig.width=7.6, fig.height=7, echo=FALSE, message=FALSE}
testdf <- eval_response( out_eval_RED$data$ddf, "results_calib/params_opt_RED.csv", overwrite = FALSE, ndays_agg = 10, makepdf=FALSE, dir = "./fig/", pattern = "RED"  )
```

There are several points here:

- This mixes responses at different time scales and within/across sites.
- The functional relationships based on the ANN look surprisingly "stiff".
- The data suggests increasing GPP across the whole temperature range, while the P-model simulates a levelling off. This could be related to the prescribed temperature sensitivity of ecosystem respiration for the flux decomposition.
- The response to VPD looks surprisingly not like $\sim1/\sqrt{D}$ in the P-model, but in the observations although the respective equation should force it to look so. Therefore, this must have to do with how the ANNs pick up relationships and the noise and correlation structure in the data.

**OPEN POINT:**

Colin has shown some plots at the ICDC that apparently Trevor produced. They show something similar as I have tried here, but as I remember, there seemed to be much more fine-structure in the functional relationships. **Trevor**, how did you do that? Using GAMs (as I remember you saying once)? I don't understand however, why the ANNs look so "stiff" here...



### Values aggregated to X days

Aggregated to longer periods, the performance slightly improves. Here, I aggregated modeled and observational data to 5-days periods.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=7.6, fig.height=7, echo=FALSE, message=FALSE}
modobs_ddf <- plot_modobs_xdaily( out_eval$data$xdf, makepdf=FALSE, xlim=c(0,20), ylim=c(0,20) )
```

- There is a pattern: Many simulated data points in the lower range tend to be too high and too low in the higher range. The lower range overestimation will definitely be improved by emprirical soil moisture, and, if applicable, a low-temperature stress function. The underestimation of values in the upper range raise a more fundamental challenge...
- The fact that the correlation improves when aggregating daily values to 5-daily values might reflect that applying the P-model as a light use efficiency model at the daily time scale violates its basic assumption related to the acclimation time scale. Non-linearities of the light-response curve imply that the ratio of GPP to absorbed light relationship declines with increasing light levels (right?). Day-to-day variations in GPP are mainly driven by light availability (not systematically investigated). Hence, anomalies of daily GPP from its mean seasonal cycle should be larger in the P-model than in the observations. This is the case as the figures below show.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=7.6, fig.height=7, echo=FALSE, message=FALSE}
modobs_anomalies_daily <- plot_modobs_anomalies_daily( out_eval_RED$data$idvdf, out_eval_RED$data$idvdf_stats, pattern = "RED", makepdf=TRUE )
```
Above figure shows the correlation and the distribution of anomalies in daily GPP from the respective mean seasonal cycle in the observations and in simulated values. Note that the blue lines in the first plot are the regression lines of daily anomalies for each site. The fact that their slope is consistently lower than 1, indicates that the day-to-day variability in simulated GPP is higher than in observed GPP. This is also reflected by the histogram in the second plot (note standard deviation values given in the upper left corner).

When plotting the same for values aggregated to 5-day bins, the standard deviation of simulated anomalies declines strongly and is in better agreement with the observations (see histogram), but the correlation analysis doesn't suggest a better performance.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=7.6, fig.height=7, echo=FALSE, message=FALSE}
modobs_anomalies_xdaily <- plot_modobs_anomalies_xdaily( out_eval$data$ixvdf, out_eval$data$ixvdf_stats, makepdf=FALSE)
```

**OPEN POINT:**

Would it be worth exploring this in more detail, e.g. quantifying the relationship between some metric and aggregation level, and 'some metric' being e.g. the standard deviation of anomalies, the *R*$^2$ of obs. vs. mod., or ... ?













<!-- **OPEN POINT:** -->

<!-- For some sites, this relationship is completely off. I'll have to have a closer look to check if the data is ok. -->

<!-- Selecting data only for sites used in the SI of our submitted manuscript (Figures S14 and S15 [see here](http://rpubs.com/stineb/si_soilm_global)), should give exactly the same figure, but it doesn't (see below). I'll have to look into what's going wrong here (thereby hopefully also resolving the open point mentioned above). -->

```{r, fig.width=7.6, fig.height=7, echo=FALSE, message=FALSE}
library(readr)
library(dplyr)
successcodes <- readr::read_csv( "successcodes.csv" )
do.sites <- dplyr::filter( successcodes, successcode==1 | successcode==2 )$mysitename
plot_modobs_spatial_annual(
  filter( out_eval_RED$data$meandf, sitename %in% do.sites),
  lm( gpp_obs ~ gpp_mod, data = filter( out_eval_RED$data$meandf, sitename %in% do.sites) ),
  filter( out_eval_RED$data$adf_stats, sitename %in% do.sites),
  makepdf=TRUE, pattern = "SOILM_GLOBAL", xlim=c(0,3000), ylim=c(0,3000) )
```

#### Spatial correlation

Comparing the multi-annual mean per site in simulated and observed GPP ($\overline{X}_i$) yields a "spatial correlation".

```{r, fig.width=7.6, fig.height=7, echo=FALSE, message=FALSE, warning=FALSE}
modobs_spatial <- plot_modobs_spatial( out_eval$data$meandf, makepdf=FALSE )
```

#### Annual GPP anomalies

Comparing annual anomalies ($X'_{i,t}$) yields insight into whether the model accurately simulates interannual variability.

```{r, fig.width=7.6, fig.height=7, echo=FALSE, message=FALSE, warning=FALSE}
modobs_anomalies_annual <- plot_modobs_anomalies_annual( out_eval$data$iavdf, out_eval$data$iavdf_stats, makepdf=FALSE )
```

### Seasonal cycle

The mean seasonal cycle is calculated as the mean by day-of-year (DOY) across multiple years.
$$
\overline{X_{\text{DOY}}} = \frac{1}{N_y} \sum_y X_{\text{DOY},y}
$$
```{r, fig.width=7.6, fig.height=7, echo=FALSE, message=FALSE, warning=FALSE}
modobs_meandoy <- plot_modobs_meandoy( out_eval_RED$data$meandoydf, out_eval_RED$data$meandoydf_stats, makepdf=TRUE, pattern = "RED" )
modobs_meandoy <- plot_modobs_meandoy( out_eval_NULL$data$meandoydf, out_eval_NULL$data$meandoydf_stats, makepdf=TRUE, pattern = "NULL" )
```




### Monthly values

Anyways, the obvious next aggregation level is monthly, and the correlation increases further to a stunning *R*$^2$ of 0.69.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=7.6, fig.height=7, echo=FALSE, message=FALSE}
modobs_mdf <- plot_modobs_monthly( out_eval$data$mdf, makepdf=FALSE )
```

### Annual values

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=7.6, fig.height=7, echo=FALSE, message=FALSE}
modobs_adf <- plot_modobs_annual( out_eval$data$adf, makepdf=FALSE )
```


# Appendix

## Sites table
```{r siteoverview, echo=FALSE, warning=FALSE, message=FALSE}
require(readr, quietly = TRUE)
require(dplyr, quietly = TRUE)
siteinfo <- readr::read_csv("siteinfo_eval.csv") %>%
            mutate( Reference = paste0("[@", sitename ,"]") ) %>%
            mutate( Period = paste0(as.character(year_start), "-", as.character(year_end)) ) %>%
            dplyr::select( -year_start, -year_end )
siteinfo %>%
  dplyr::rename( Site=sitename, Lon.=lon, Lat.=lat, Elevation=elv, Veg.=classid, Clim.=koeppen_code, N = ndailygpp ) %>%
  dplyr::select( Site, Lon., Lat., Period, Veg., Clim., N, Reference ) %>%
  knitr::kable( caption = "Sites used for evaluation. Lon. is longitude, negative values indicate west longitude; Lat. is latitude, positive values indicate north latitude; Veg. is vegetation type: deciduous broadleaf forest (DBF); evergreen broadleaf forest (EBF); evergreen needleleaf forest (ENF); grassland (GRA); mixed deciduous and evergreen needleleaf forest (MF); savanna ecosystem (SAV); shrub ecosystem (SHR); wetland (WET)." )
```


## Mean seasonality by site

Observed values are in black, simulated in red. The solid line in the centre of the shaded range is the mean by day of year (DOY) across multiply years, shaded ranges indicate the minimum and maximum by DOY across years.

```{r, fig.width=7.6, fig.height=7, echo=FALSE, message=FALSE, warning=FALSE}
plot_by_doy_allsites( out_eval$data$meandoydf_stats, makepdf=FALSE )
```
